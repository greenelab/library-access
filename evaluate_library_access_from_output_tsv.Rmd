---
title: "Evaluate Library Access from the Output TSV"
author: "Jacob Levernier"
date: "2017"
output: pdf_document
---

```{r setup, include=FALSE}
library('ggplot2')

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(results = "asis")
```

```{r settings}
lzma_compressed_library_access_tsv_location <- "library-access/data/library_coverage_xml_and_fulltext_indicators.tsv.xz"

original_dataset_with_oa_color_column_location <- paste0(
  'https://github.com/greenelab/scihub/raw/',
  '4172526ac7433357b31790578ad6f59948b6db26/data/',
  'state-of-oa-dois.tsv.xz')

original_dataset_with_oa_color_column_location <- "/home/jacoblevernier/Downloads/state-of-oa-dois.tsv.xz"
```


```{r read datasets}
lzma_compressed_library_access_tsv <- read.table(
  gzfile(lzma_compressed_library_access_tsv_location),
  sep = '\t',
  header = TRUE
)
# View(lzma_compressed_library_access_tsv)  # Check the dataset

# Create a temporary filepath for downloading the original dataset.
# Then download and read it.
tmp_filpath_for_original_dataset <- tempfile()

download.file(
  original_dataset_with_oa_color_column_location,
  destfile = tmp_filpath_for_original_dataset,
  mode = 'wb'
)

original_dataset_with_oa_color_column <- read.table(
  gzfile(tmp_filpath_for_original_dataset),
  sep = '\t',
  header = TRUE
)
# View(original_dataset_with_oa_color_column)  # Check the dataset
```

```{r merge the datasets}
# Combine the datasets so that we have doi, full_text_indicator, and oadoi_color
merged_datasets <- merge(
  original_dataset_with_oa_color_column,
  lzma_compressed_library_access_tsv,
  by = "doi"
)
# View(merged_datasets)  # Check our work
```

## Summary of the downloaded dataset

```{r analyze the merged dataset}
merged_datasets_without_doi_column <- merged_datasets[
  ,  # Use all rows
  c("oadoi_color", "full_text_indicator")
]

frequency_table_by_oa_color <- table(merged_datasets_without_doi_column)
# View(frequency_table_by_oa_color)

proportion_table_by_oa_color <- prop.table(
  frequency_table_by_oa_color,
  margin = 1)*100

frequency_and_proportion_table <- data.frame(
  "oa_doi_color" = rownames(proportion_table_by_oa_color),
  "no_access_percent" = proportion_table_by_oa_color[,1],
  "yes_access_percent" = proportion_table_by_oa_color[,2],
  "yes_access_rate" = frequency_table_by_oa_color[, 2]
)
rownames(frequency_and_proportion_table) <- NA
# View(frequency_and_proportion_table)

frequency_bar_chart <- ggplot(
  data = merged_datasets_without_doi_column,
  aes(x = oadoi_color, fill = factor(full_text_indicator))
) +
geom_bar(stat = "count", position = position_dodge()) +
geom_text(aes(label=y), vjust=0) +
xlab("OA Color") +
ylab("Count") +
labs(fill = "Full-Text Status") +
theme_classic() +
theme(axis.text.x = element_text(angle = 90)) +
coord_flip()
```

The dataset contained 

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
